<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Prenotazioni Tennis</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
/* ===== RESET BASE ===== */
* { box-sizing: border-box; margin:0; padding:0; }
body {font-family: Arial, sans-serif; background: #f4f6f8;}

/* ===== CONTAINER ===== */
.container {width:95%; max-width:900px; margin:auto;}
.logo-login {width:150px; margin:20px auto; display:block;}
h2 {text-align:center; margin-bottom:20px;}

/* ===== INPUT E BOTTONI ===== */
input {width:85%; max-width:420px; display:block; margin:8px auto; padding:12px; border-radius:6px; border:1px solid #ccc; font-size:1rem;}
button {width:85%; max-width:420px; display:block; margin:16px auto; padding:12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; background:#6a1b9a; color:white; transition: all 0.3s;}

/* Hover generico per button (non tab active) */
button:hover {background:#7e2bcf; color:white;}

/* ===== TAB LOGIN/REG ===== */
#authTabs {display:flex; justify-content:center; gap:10px; margin-bottom:20px;}
.tabButton {
  flex:1; 
  padding:10px 0; 
  cursor:pointer; 
  font-weight:bold; 
  border-radius:6px; 
  border:none; 
  transition: background 0.3s, color 0.3s;
}
/* Tab selezionata */
.tabButton.active {background:white; color:#6a1b9a; border:2px solid #6a1b9a;}
/* Hover solo se NON active */
.tabButton:not(.active):hover {background:#8e44ad; color:white;}

/* ===== PASSWORD TOGGLE ===== */
.password-toggle {width:85%; max-width:420px; margin:8px auto; display:flex; align-items:center; gap:8px; font-size:0.95rem; flex-wrap: nowrap; white-space: nowrap;}
.password-toggle input[type="checkbox"] {margin:0; cursor:pointer;}

/* ===== LINK PASSWORD DIMENTICATA ===== */
.forgot-password {text-align:center; margin-top:10px;}
.forgot-password a {color:#6a1b9a; font-weight:bold; text-decoration:none;}
.forgot-password a:hover {text-decoration:underline; flex-shrink:0;}

/* ===== FORM NASCOSTO ===== */
#loginForm, #registerForm {display:flex; flex-direction:column;}

/* ===== ERROR MESSAGE ===== */
#errorMsg {text-align:center; color:red; margin-top:10px;}

/* ===== MODAL RESET PASSWORD===== */
.modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:999;}
.modal-box{ background:#fff; padding:25px; border-radius:10px; width:90%; max-width:400px;}
.modal-box input{ width:100%; padding:10px; margin-bottom:12px;}
.modal-actions{ display:flex; justify-content:space-between;}

</style>

</head>

<body>
<div class="container" id="loginPage">
  <img src="https://drive.google.com/thumbnail?id=1gozdQWrZKRs7PLNRrW-td4Ky4ehhhjmj&sz=w200" class="logo-login">
  <h2>Registrati o effettua l'accesso</h2>

  <div id="authTabs">
    <button class="tabButton active" onclick="showAuthTab('login')">LOGIN</button>
    <button class="tabButton" onclick="showAuthTab('register')">REGISTRATI</button>
  </div>

  <!-- LOGIN -->
  <div id="loginForm">
    <input type="email" id="login_email" placeholder="Email">
    <input type="password" id="login_pass" placeholder="Password">
    <div class="password-toggle">
      <span>Mostra password</span>
      <input type="checkbox" onclick="togglePassword('login_pass')">
    </div>
    <button onclick="login()">Accedi</button>
    <p class="forgot-password">
      <a href="#" onclick="forgotPassword()">Password dimenticata?</a>
    </p>
  </div>

  <!-- REGISTRAZIONE -->
  <div id="registerForm" style="display:none;">
    <input type="text" id="reg_nome" placeholder="Nome">
    <input type="text" id="reg_cognome" placeholder="Cognome">
    <input type="email" id="reg_email" placeholder="Email">
    <input type="password" id="reg_pass" placeholder="Password">
    <input type="password" id="reg_pass_confirm" placeholder="Conferma Password">
    <div class="password-toggle">
      <span>Mostra password</span>
      <input type="checkbox" onclick="togglePassword('reg_pass','reg_pass_confirm')">
    </div>
    <button onclick="register()">Registrati</button>
  </div>

  <div id="errorMsg"></div>
</div>

<!-- MODAL PASSWORD DIMENTICATA -->
<div id="resetModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Reimposta password</h2>

    <label>Email</label>
    <input type="email" id="resetEmail">

    <label>Nuova password</label>
    <input type="password" id="resetPassword">

    <label>Conferma password</label>
    <input type="password" id="resetPasswordConfirm">

    <div class="modal-actions">
      <button onclick="closeResetModal()">Annulla</button>
      <button class="primary-button" onclick="confirmResetPassword()">Conferma</button>
    </div>
  </div>
</div>

<script>
// ---------- VARIABILI GLOBALI ----------
let currentUser = null;

// ---------- API FETCH ----------
async function apiFetch(endpoint, method='POST', body={}) {
  const res = await fetch(endpoint,{
    method,
    headers:{'Content-Type':'application/json'},
    body: method==='POST' ? JSON.stringify(body) : undefined
  });
  return res.json();
}

// ---------- LOGIN ----------
async function login(){
  const email = document.getElementById('login_email').value;
  const password = document.getElementById('login_pass').value;
  const res = await apiFetch('/api/login','POST',{email,password});
  if(res.ok){
    currentUser = {email, nome:res.nome, ruolo:res.ruolo};
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    window.location.href = '/app.html';
  } else {
    showError(res.msg);
  }
}

// ---------- REGISTRAZIONE ----------
async function register(){
  const email = document.getElementById('reg_email').value;
  const nome = document.getElementById('reg_nome').value;
  const cognome = document.getElementById('reg_cognome').value;
  const password = document.getElementById('reg_pass').value;
  const passwordConfirm = document.getElementById('reg_pass_confirm').value;

  const res = await apiFetch('/api/register','POST',{email,nome,cognome,password,passwordConfirm});
  if(res.ok){
    currentUser = {email,nome,ruolo:'utente'};
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    window.location.href = '/app.html';
  } else {
    showError(res.msg);
  }
}

// ---------- RESET PASSWORD ----------
function openResetModal(){
  document.getElementById('resetModal').style.display = 'flex';
}

function closeResetModal(){
  document.getElementById('resetModal').style.display = 'none';
}

async function confirmResetPassword(){
  const email = document.getElementById('resetEmail').value.trim();
  const pass1 = document.getElementById('resetPassword').value;
  const pass2 = document.getElementById('resetPasswordConfirm').value;

  if(!email || !pass1 || !pass2){
    alert('Compila tutti i campi');
    return;
  }

  if(pass1 !== pass2){
    alert('Le password non coincidono');
    return;
  }

  const res = await apiFetch('/api/resetPassword','POST',{
    email,
    newPassword: pass1,
    confirmPassword: pass2
  });

  alert(res.ok ? 'Password aggiornata' : res.msg);
  if(res.ok) closeResetModal();
}

// ---------- MOSTRA/NASCONDI PASSWORD ----------
function togglePassword(...ids){
  ids.forEach(id=>{
    const input = document.getElementById(id);
    input.type = input.type==='password'?'text':'password';
  });
}

// ---------- TAB LOGIN/REG ----------
function showAuthTab(tab){
  document.getElementById('loginForm').style.display = tab==='login'?'flex':'none';
  document.getElementById('registerForm').style.display = tab==='register'?'flex':'none';
  const tabs = document.querySelectorAll('#authTabs .tabButton');
  tabs.forEach((btn,i)=> btn.classList.remove('active'));
  if(tab==='login') tabs[0].classList.add('active');
  else tabs[1].classList.add('active');
}

// ---------- ERROR MESSAGE ----------
function showError(msg){
  const div = document.getElementById('errorMsg');
  div.textContent = msg;
}

// ---------- AUTO REDIRECT SE LOGGATO ----------
window.onload = ()=>{
  const saved = JSON.parse(localStorage.getItem('currentUser')||'{}');
  if(saved?.email) window.location.href='/app.html';
};
</script>
</body>
</html>
