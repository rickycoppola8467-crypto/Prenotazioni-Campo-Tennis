<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prenotazioni Campo Tennis</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
/* ===== RESET BASE ===== */
* { box-sizing: border-box; margin:0; padding:0; }
body {font-family: Arial, sans-serif; background: #f4f6f8;}

/* ===== CONTAINER ===== */
.container {width:95%; max-width:1200px; margin:auto;}

/* ===== TOP BAR ===== */
#topBar { display:flex; background:#6a1b9a; height:60px; align-items:center; justify-content:space-between; padding:0 10px; }
#topBar .logo-bar {width:50px; height:50px; object-fit:contain;}
.topButton {flex: 1; margin:0 5px; padding:10px; background:#6a1b9a; color:white; border-radius:6px; font-weight:bold; cursor:pointer; text-align:center; transition: all 0.2s;}
.topButton:hover {background:#7e2bcf;}
.topButton.active {background:white; color:#6a1b9a; border:2px solid #6a1b9a;}

/* ===== CALENDARIO LAYOUT ===== */
#calendarSection {display:flex; gap:20px; padding:20px 0;}
#bookingForm {flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;}
#bookingForm label {font-size:1.2rem; margin:10px 0 5px 0; width:85%; max-width:420px;}
#bookingForm input, #bookingForm select {font-size:1.1rem; width:85%; max-width:420px; margin-bottom:12px; padding:12px; border-radius:6px; border:1px solid #ccc;}
#bookingForm button {font-size:1.2rem; margin-top:12px;}

/* ===== SLOT LAYOUT ===== */
#calendarSlots {flex:1; display:flex; gap:10px; height:600px;}
.slots-column {flex:1; display:flex; flex-direction:column; align-items:center; overflow-y:auto; padding:0 5px;}

/* ===== SLOT DISPONIBILI E OCCUPATI ===== */
.slots-column h3 {margin-bottom:12px; text-align:center;}
.slot-libero, .slot-occupato {
  width:90%; min-height:60px; margin:8px 0; border-radius:6px; font-weight:bold; display:flex; align-items:center; justify-content:center; text-align:center; padding:8px;
}
.slot-libero {background:#4caf50; color:white; cursor:pointer;}
.slot-occupato {background:#f44336; color:black; cursor:default;}

/* Se la colonna supera l‚Äô80% dell‚Äôaltezza, scrollabile */
#slotsFree, #slotsBusy {flex:1; width:100%; overflow-y:auto; max-height:100%;}

/* ===== STORICO PRENOTAZIONI ===== */
.booking-upcoming {background:#4caf50; color:white; font-weight:bold; padding:10px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;}
.booking-past {background:#e0e0e0; color:black; font-weight:bold; padding:10px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;}

/* ===== BOTTONE CANCELLA ===== */
.delete-booking-btn {background:white; color:red; border:2px solid red; border-radius:4px; cursor:pointer; padding:4px 6px; margin-left:10px; transition:all 0.2s;}
.delete-booking-btn:hover {background:red; color:white;}
</style>

</head>

<body>
<div id="appPage">
  <!-- TOP BAR -->
  <div id="topBar">
    <img src="https://drive.google.com/thumbnail?id=1gozdQWrZKRs7PLNRrW-td4Ky4ehhhjmj&sz=w200" class="logo-bar">
    <div class="topButton" onclick="showSection('home')">HOME</div>
    <div class="topButton" onclick="showSection('calendar')">CALENDARIO</div>
    <div class="topButton" onclick="showSection('myBookings')">STORICO PRENOTAZIONI</div>
    <div class="topButton" onclick="showSection('profile')">PROFILO</div>
    <div class="topButton" onclick="showSection('gallery')">GALLERY</div>
    <div class="topButton" onclick="logout()">LOGOUT</div>
  </div>

  <div class="container" id="appContent">
    <!-- HOME -->
    <div id="homeSection" class="section">
      <h2>Benvenuto!</h2>
      <p>Qui potrai visualizzare tutte le novit√† del circolo.</p>
    </div>

    <!-- CALENDARIO -->
    <div id="calendarSection" class="section">
      <div id="bookingForm">
        <h2>Effettua la prenotazione del tuo campo!</h2>
        <label>Data</label>
        <input type="date" id="data">
        <label>Campo</label>
        <select id="campo">
          <option>Campo 1</option>
          <option>Campo 2</option>
        </select>
        <label>Durata</label>
        <select id="durata">
          <option value="1">1 ora</option>
          <option value="2">2 ore</option>
        </select>
        <label id="userLabel" style="display:none;">Prenota per:</label>
        <select id="selectUser" style="display:none;"></select>
        <button onclick="loadSlots()">Cerca disponibilit√†</button>
      </div>
      <div id="calendarSlots">
        <div class="slots-column">
          <h3>Disponibili</h3>
          <div id="slotsFree"></div>
        </div>
        <div class="slots-column">
          <h3>Occupati</h3>
          <div id="slotsBusy"></div>
        </div>
      </div>
    </div>

    <!-- STORICO PRENOTAZIONI -->
    <div id="myBookingsSection" class="section">
      <h2>Storico prenotazioni</h2>
      <div id="myBookingsList"></div>
    </div>

    <!-- PROFILO -->
    <div id="profileSection" class="section">
      <h2>Profilo</h2>
      <p>Gestisci le informazioni del tuo account.</p>
    </div>

    <!-- GALLERY -->
    <div id="gallerySection" class="section">
      <h2>Galleria</h2>
      <p>Carica e/o visualizza la galleria del circolo.</p>
    </div>
  </div>
</div>

<script>
// ---------- VARIABILI GLOBALI ----------
let currentUser = JSON.parse(localStorage.getItem('currentUser')||'{}');

// ---------- FUNZIONE FETCH ----------
async function apiFetch(endpoint, method='POST', body={}) {
  const res = await fetch(endpoint,{
    method,
    headers:{'Content-Type':'application/json'},
    body: method==='POST'? JSON.stringify(body) : undefined
  });
  return res.json();
}

// ---------- SHOW SEZIONE ----------
function showSection(sec){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  const map = {home:'homeSection', calendar:'calendarSection', myBookings:'myBookingsSection', profile:'profileSection', gallery:'gallerySection'};
  const section = document.getElementById(map[sec]);
  if(section) section.style.display = sec==='calendar'?'flex':'block';

  document.querySelectorAll('#topBar .topButton').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`#topBar .topButton[onclick="showSection('${sec}')"]`).classList.add('active');
}

// ---------- LOGOUT ----------
function logout(){
  localStorage.removeItem('currentUser');
  window.location.href='/login.html';
}

// ---------- SLOT CALENDARIO ----------
async function loadSlots(){
  if(!currentUser?.email){ alert('Devi fare login'); return; }
  const data = document.getElementById('data').value;
  const campo = document.getElementById('campo').value;
  const durata = Number(document.getElementById('durata').value);

  const res = await apiFetch('/api/getSlots','POST',{data,campo,durata});
  showSlots(res);
}

// ---------- SLOT CALENDARIO ----------
function showSlots(data){
  const freeDiv = document.getElementById('slotsFree');
  const busyDiv = document.getElementById('slotsBusy');
  freeDiv.innerHTML = ''; 
  busyDiv.innerHTML = '';

  if(data.free.length===0) freeDiv.innerHTML = '<p>Nessuna disponibilit√†</p>';
  data.free.forEach(s => {
    const btn = document.createElement('button');
    btn.textContent = s.start; // es. 8:00, 9:00 ecc.
    btn.className = 'slot-libero';
    btn.onclick = () => book(s.start);
    freeDiv.appendChild(btn);
  });

  if(data.busy.length===0) busyDiv.innerHTML = '<p>Nessuna prenotazione</p>';
  data.busy.forEach(b => {
    const div = document.createElement('div');
    div.className = 'slot-occupato';
    div.textContent = `${b.start}-${b.end} | Occupato da ${b.userNome}`;
    busyDiv.appendChild(div);
  });
}

// ---------- PRENOTAZIONE ----------
async function book(ora){
  if(!currentUser?.email){ alert('Devi fare login'); return; }
  const data = document.getElementById('data').value;
  const campo = document.getElementById('campo').value;
  const durata = Number(document.getElementById('durata').value);
  let email = currentUser.email;
  if(currentUser.ruolo==='admin'){
    const select = document.getElementById('selectUser');
    if(select.value) email = select.value;
  }
  if(!confirm(`Prenotare campo ${campo} il ${data} alle ${ora}?`)) return;
  const res = await apiFetch('/api/book','POST',{email,nome:currentUser.nome,campo,data,ora,durata});
  alert(res.ok?'Prenotazione confermata':'Errore');
  if(res.ok){ loadSlots(); loadMyBookings(); }
}

// ---------- STORICO PRENOTAZIONI ----------
async function loadMyBookings(){
  if(!currentUser?.email) return;
  const data = await apiFetch(`/api/myBookings/${currentUser.email}`,'GET');
  displayMyBookings(data);
}

function displayMyBookings(data){
  const div = document.getElementById('myBookingsList');
  div.innerHTML='';
  if(!data || data.length===0){ div.innerHTML='<p>Nessuna prenotazione</p>'; return; }
  const now = new Date();
  data.forEach(b=>{
    const d = document.createElement('div');
    const bookingDate = new Date(b.start);
    d.className = bookingDate>=now?'booking-upcoming':'booking-past';
    d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
    d.textContent = `${b.start} ${b.startHour||''}-${b.end||''} | Campo: ${b.campo}`;
    const delBtn = document.createElement('button');
    delBtn.className='delete-booking-btn';
    delBtn.title='Elimina prenotazione';
    delBtn.innerHTML='üóëÔ∏è';
    delBtn.onclick=()=>deleteBooking(b.id);
    d.appendChild(delBtn);
    div.appendChild(d);
  });
}

// ---------- CANCELLA PRENOTAZIONE ----------
async function deleteBooking(id){
  const motivo = prompt("Motivo cancellazione:\n1. Prenotazione errata\n2. Meteo\n3. Imprevisto\n4. Altro","Prenotazione errata");
  if(!motivo) return;
  if(!confirm("Sei sicuro di eliminare la prenotazione?")) return;
  const res = await apiFetch('/api/deleteBooking','POST',{id});
  alert(res.ok?'Prenotazione eliminata':'Errore');
  if(res.ok) loadMyBookings();
}

// ---------- ONLOAD ----------
window.onload = ()=>{
  if(!currentUser?.email){
    window.location.href='/login.html';
    return;
  }
  showSection('home');
  loadMyBookings();
  if(currentUser.ruolo==='admin') applyRoleUI();
};

// ---------- APPLICA RUOLO ADMIN ----------
async function applyRoleUI() {
  if(currentUser?.ruolo === 'admin') {
    document.getElementById('userLabel').style.display = 'block';
    const select = document.getElementById('selectUser');
    select.style.display = 'block';
    const users = await apiFetch('/api/allUsers','GET');
    select.innerHTML = '';
    users.forEach(u => {
      // Punti 3: aggiungiamo iniziali del cognome
      let displayName = u.nome;
      if(u.cognome) displayName += ' ' + u.cognome[0] + '.';
      const opt = document.createElement('option');
      opt.value = u.email;
      opt.textContent = displayName;
      select.appendChild(opt);
    });
  }
}

</script>
</body>
</html>
