<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prenotazioni Campo Tennis</title>
<link rel="icon" type="image/png" href="favicon.png">

<style>
/* ===== RESET BASE ===== */
* { box-sizing: border-box; margin:0; padding:0; }
body {font-family: Arial, sans-serif; background: #f4f6f8;}

/* ===== CONTAINER ===== */
.container {width:95%; max-width:1200px; margin:auto;}

/* ===== TOP BAR ===== */
#topBar { display:flex; background:#6a1b9a; height:60px; align-items:center; justify-content:space-between; padding:0 10px; }
#topBar .logo-bar {width:50px; height:50px; object-fit:contain;}
.topButton {flex: 1; margin:0 5px; padding:10px; background:#6a1b9a; color:white; border-radius:6px; font-weight:bold; cursor:pointer; text-align:center; transition: all 0.2s;}
.topButton:hover {background:#7e2bcf;}
.topButton.active {background:white; color:#6a1b9a; border:2px solid #6a1b9a;}

/* ===== CALENDARIO LAYOUT ===== */
#calendarSection {display:flex; gap:20px; padding:20px 0; justify-content:flex-start;}
#bookingForm {flex: 1; display:flex; flex-direction:column; align-items:flex-start; justify-content:flex-start;}
#bookingForm label {font-size:1.2rem; margin:10px 0 5px 0; width:85%; max-width:420px;}
#bookingForm input, #bookingForm select {font-size:1rem; width:85%; max-width:400px; margin-bottom:10px; padding:10px; border-radius:6px; border:1px solid #ccc;}
#bookingForm button { font-size:1.1rem; margin-top:15px; padding:12px; width:85%; max-width:400px; align-self:flex-start;}

/* ===== SLOT LAYOUT ===== */
#calendarSlots {flex:1; display:flex; gap:10px; height:600px;}
.slots-column {flex:1; display:flex; flex-direction:column; align-items:center; overflow-y:auto; padding:0 5px;}

/* ===== SLOT DISPONIBILI E OCCUPATI ===== */
.slots-column h3 {margin-bottom:12px; text-align:center;}
.slot-libero, .slot-occupato {
  width:90%; min-height:60px; margin:8px 0; border-radius:6px; font-weight:bold; display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; font-size:1.3rem;}
.slot-libero {background:#4caf50; color:white; cursor:pointer;}
.slot-occupato {background:#f44336; color:black; cursor:default;}
/* Se la colonna supera l‚Äô80% dell‚Äôaltezza, scrollabile */
#slotsFree, #slotsBusy {flex:1; width:100%; overflow-y:auto; max-height:100%;}

/* ===== STORICO PRENOTAZIONI ===== */
.booking-upcoming {background:#4caf50; color:white; font-weight:bold; padding:10px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;}
.booking-past {background:#d3d3d3; color:black; font-weight:bold; padding:10px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;}

.primary-button {width:85%; max-width:420px; margin:16px auto; padding:14px; background:#6a1b9a;
  color:white; border:none; border-radius:8px; font-size:1.2rem; font-weight:bold; cursor:pointer; transition:all 0.3s ease;}
.primary-button:hover {background:#7e2bcf;}

/* ===== BOTTONE CANCELLA ===== */
.delete-booking-btn {background:white; color:red; border:2px solid red; border-radius:4px; cursor:pointer; padding:4px 6px; margin-left:10px; transition:all 0.2s;}
.delete-booking-btn:hover {background:red; color:white;}

/* ===== MODAL ===== */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:999;}
.modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:420px; display:flex; flex-direction:column; gap:10px;}
.modal-content label { font-size:1.1rem;}
.modal-content textarea { resize:none; min-height:80px; padding:10px; font-size:1rem;}
.modal-actions { display:flex; justify-content:flex-end; gap:10px;}
.modal-actions .danger { background:#f44336; color:white;}

</style>

</head>

<body>
<div id="appPage">
  <!-- TOP BAR -->
  <div id="topBar">
    <img src="https://drive.google.com/thumbnail?id=1gozdQWrZKRs7PLNRrW-td4Ky4ehhhjmj&sz=w200" class="logo-bar">
<div class="topButton" data-section="home" onclick="showSection('home')">HOME</div>
<div class="topButton" data-section="calendar" onclick="showSection('calendar')">CALENDARIO</div>
<div class="topButton" data-section="myBookings" onclick="showSection('myBookings')">STORICO PRENOTAZIONI</div>
<div class="topButton" data-section="profile" onclick="showSection('profile')">PROFILO</div>
<div class="topButton" data-section="gallery" onclick="showSection('gallery')">GALLERY</div>
<div class="topButton" data-section="logout" onclick="logout()">LOGOUT</div>

  </div>

  <div class="container" id="appContent">
    <!-- HOME -->
    <div id="homeSection" class="section">
      <h2>Benvenuto!</h2>
      <p>Qui potrai visualizzare tutte le novit√† del circolo.</p>
    </div>

    <!-- CALENDARIO -->
    <div id="calendarSection" class="section">
      <div id="bookingForm">
        <h2>Effettua la prenotazione del tuo campo!</h2>
        <label>Data</label>
        <input type="date" id="data">
        <label>Campo</label>
        <select id="campo">
          <option>Campo 1</option>
          <option>Campo 2</option>
        </select>
        <label>Durata</label>
        <select id="durata">
          <option value="1">1 ora</option>
          <option value="2">2 ore</option>
        </select>
        <label id="userLabel" style="display:none;">Prenota per:</label>
        <select id="selectUser" style="display:none;"></select>
        <button class="primary-button" id="searchSlotsBtn" onclick="searchAvailability()">Cerca 	disponibilit√†</button>

      </div>
      <div id="calendarSlots">
        <div class="slots-column">
          <h3>Disponibili</h3>
          <div id="slotsFree"></div>
        </div>
        <div class="slots-column">
          <h3>Occupati</h3>
          <div id="slotsBusy"></div>
        </div>
      </div>
    </div>

    <!-- STORICO PRENOTAZIONI -->
    <div id="myBookingsSection" class="section">
      <h2>Storico prenotazioni</h2>
      <div id="myBookingsList"></div>
    </div>

    <!-- PROFILO -->
    <div id="profileSection" class="section">
      <h2>Profilo</h2>
      <p>Gestisci le informazioni del tuo account.</p>
    </div>

    <!-- GALLERY -->
    <div id="gallerySection" class="section">
      <h2>Galleria</h2>
      <p>Carica e/o visualizza la galleria del circolo.</p>
    </div>
  </div>
</div>

<!-- MODAL ANNULLA PRENOTAZIONE -->
<div id="cancelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Motivo annullamento</h3>

    <label><input type="radio" name="cancelReason" value="Prenotazione errata"> Prenotazione errata</label>
    <label><input type="radio" name="cancelReason" value="Meteo"> Meteo</label>
    <label><input type="radio" name="cancelReason" value="Imprevisto"> Imprevisto</label>
    <label><input type="radio" name="cancelReason" value="Altro"> Altro</label>

    <textarea id="otherReason" placeholder="Scrivi il motivo..."
      disabled></textarea>

    <div class="modal-actions">
      <button onclick="closeCancelModal()">Annulla</button>
      <button class="danger" onclick="confirmCancel()">Conferma</button>
    </div>
  </div>
</div>

<script>
// ---------- VARIABILI GLOBALI ----------
let currentUser = JSON.parse(localStorage.getItem('currentUser')||'{}');
let bookingToDelete = null;

// ---------- FUNZIONE FETCH ----------
async function apiFetch(endpoint, method='POST', body={}) {
  const res = await fetch(endpoint,{
    method,
    headers:{'Content-Type':'application/json'},
    body: method==='POST'? JSON.stringify(body) : undefined
  });
  return res.json();
}

// ---------- SHOW SEZIONE ----------
function showSection(id){
  // Nasconde tutte le sezioni
  document.querySelectorAll('.section').forEach(s => s.style.display='none');
  const section = document.getElementById(id+'Section');
  if(section) section.style.display='block';

  // Aggiorna i bottoni attivi
  document.querySelectorAll('.topButton').forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`.topButton[data-section="${id}"]`);
  if(btn) btn.classList.add('active');

  // Salva sezione attiva
  localStorage.setItem('activeSection', id);
}

// ---------- LOGOUT ----------
function logout(){
  localStorage.removeItem('currentUser');
  window.location.href='/login.html';
}

// ---------- CARICA SLOT CALENDARIO ----------
async function searchAvailability() {
  if(!currentUser?.email){ 
    alert('Devi fare login'); 
    return; 
  }

  const data = document.getElementById('data').value;
  if(!data){
    alert('Seleziona una data prima di cercare la disponibilit√†');
    return;
  }

  const campo = document.getElementById('campo').value;
  const durata = Number(document.getElementById('durata').value);

  const res = await apiFetch('/api/getSlots','POST',{data,campo,durata});
  showSlots(res);
}

// ---------- MOSTRA SLOT CALENDARIO ----------
function showSlots(data){
  const freeDiv = document.getElementById('slotsFree');
  const busyDiv = document.getElementById('slotsBusy');
  freeDiv.innerHTML = ''; 
  busyDiv.innerHTML = '';

  // SLOT LIBERI
  if(!data.free || data.free.length === 0){
    freeDiv.innerHTML = '<p>Nessuna disponibilit√†</p>';
  } else {
    data.free.forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'slot-libero';
      btn.textContent = s.start; // es. "08:00"
      btn.onclick = () => book(s.start);
      freeDiv.appendChild(btn);
    });
  }

  // SLOT OCCUPATI
  if(!data.busy || data.busy.length === 0){
    busyDiv.innerHTML = '<p>Nessuna prenotazione</p>';
  } else {
    data.busy.forEach(b => {
      const div = document.createElement('div');
      div.className = 'slot-occupato';

      const start = typeof b.start === 'number'
        ? minutesToTime(b.start)
        : b.start;

      const end = typeof b.end === 'number'
        ? minutesToTime(b.end)
        : b.end;

      div.textContent = `${start} - ${end} | Occupato da ${b.userNome}`;
      busyDiv.appendChild(div);
    });
  }
}

// ---------- PRENOTAZIONE ----------
async function book(ora){
  if(!currentUser?.email){ alert('Devi fare login'); return; }
  const data = document.getElementById('data').value;
  const campo = document.getElementById('campo').value;
  const durata = Number(document.getElementById('durata').value);
  let email = currentUser.email;
  if(currentUser.ruolo==='admin'){
    const select = document.getElementById('selectUser');
    if(select.value) email = select.value;
  }
  if(!confirm(`Prenotare campo ${campo} il ${data} alle ${ora}?`)) return;
  const res = await apiFetch('/api/book','POST',{email,nome:currentUser.nome,campo,data,ora,durata});
  alert(res.ok?'Prenotazione confermata':'Errore');
  if(res.ok){ loadSlots(); loadMyBookings(); }
}

// ---------- STORICO PRENOTAZIONI ----------
async function loadMyBookings(){
  if(!currentUser?.email) return;
  const data = await apiFetch(`/api/myBookings/${currentUser.email}`,'GET');
  displayMyBookings(data);
}

function displayMyBookings(data){
  const div = document.getElementById('myBookingsList');
  div.innerHTML = '';

  if(!data || data.length === 0){
    div.innerHTML = '<p>Nessuna prenotazione</p>';
    return;
  }

  const now = new Date();

  data.forEach(b => {
    const row = document.createElement('div');
    
    // ---- Calcolo orario prenotazione ----
    const [year, month, day] = b.start.split('-').map(Number);
    const endTimeParts = minutesToTime(b.endMinutes).split(':').map(Number);
    const bookingEnd = new Date(year, month-1, day, endTimeParts[0], endTimeParts[1]);

    row.className = bookingEnd > now ? 'booking-upcoming' : 'booking-past';
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';

    // ---- TESTO PRENOTAZIONE ----
    const startTime = minutesToTime(b.startMinutes);
    const endTime = minutesToTime(b.endMinutes);

    const info = document.createElement('div');
    info.textContent = `${b.start} | ${startTime}-${endTime} | Campo: ${b.campo}`;

    // ---- BOTTONE ELIMINA IN WRAPPER SEPARATO ----
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-booking-btn';
    delBtn.title = 'Elimina prenotazione';
    delBtn.innerHTML = 'üóëÔ∏è';
    delBtn.onclick = () => deleteBooking(b.id);

    const infoWrapper = document.createElement('div');
    infoWrapper.appendChild(info);

    const btnWrapper = document.createElement('div');
    btnWrapper.appendChild(delBtn);

    row.appendChild(infoWrapper);
    row.appendChild(btnWrapper);

    div.appendChild(row);
  });
}

// ---------- CANCELLA PRENOTAZIONE ----------
function deleteBooking(id){
  bookingToDelete = id; // salva ID
  document.getElementById('cancelModal').style.display = 'flex';

  // reset stato modal
  document.querySelectorAll('input[name="cancelReason"]').forEach(r => r.checked = false);
  document.getElementById('otherReason').value = '';
  document.getElementById('otherReason').disabled = true;
}

function closeCancelModal(){
  document.getElementById('cancelModal').style.display = 'none';
  bookingToDelete = null;
}

async function confirmCancel(){
  const selected = document.querySelector('input[name="cancelReason"]:checked');
  if(!selected){
    alert('Seleziona un motivo');
    return;
  }

  let motivo = selected.value;

  if(motivo === 'Altro'){
    const text = document.getElementById('otherReason').value.trim();
    if(!text){
      alert('Scrivi il motivo');
      return;
    }
    motivo = `Altro: ${text}`;
  }

  const res = await apiFetch('/api/deleteBooking','POST',{
    id: bookingToDelete,
    motivo
  });

  alert(res.ok ? 'Prenotazione annullata' : 'Errore');
  closeCancelModal();
  if(res.ok) loadMyBookings();
}

// ---------- ONLOAD ----------
window.onload = ()=>{
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  if(!currentUser?.email){
    window.location.href='/login.html';
    return;
  }
    const lastSection = localStorage.getItem('activeSection') || 'home';
  showSection(lastSection);
  applyRoleUI();
  loadMyBookings();
};

// ---------- APPLICA RUOLO ADMIN ----------
async function applyRoleUI() {
  if(currentUser?.ruolo === 'admin') {
    document.getElementById('userLabel').style.display = 'block';
    const select = document.getElementById('selectUser');
    select.style.display = 'block';
    const users = await apiFetch('/api/allUsers','GET');
    select.innerHTML = '';
    users.forEach(u => {
      // Punti 3: aggiungiamo iniziali del cognome
      let displayName = u.nome;
      if(u.cognome) displayName += ' ' + u.cognome[0] + '.';
      const opt = document.createElement('option');
      opt.value = u.email;
      opt.textContent = displayName;
      select.appendChild(opt);
    });
  }
}

function timeToMinutes(timeStr){
  const [h,m] = timeStr.split(':').map(Number);
  return h*60 + m;
}
function minutesToTime(mins){
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return `${h}:${m===0?'00':m}`;
}

 // Listener radio "Altro"
document.querySelectorAll('input[name="cancelReason"]').forEach(radio=>{
  radio.addEventListener('change', ()=>{
    const other = document.getElementById('otherReason');
    if(radio.value === 'Altro'){
      other.disabled = false;
      other.focus();
    } else {
      other.disabled = true;
      other.value = '';
    }
  });
});

</script>
</body>
</html>
